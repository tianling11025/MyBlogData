---
title: Samba远程代码执行漏洞(CVE-2017-7494)
date: 2017-05-25 15:28:42
comments: true
tags:
- Samba漏洞
- CVE-2017-7494
categories: 系统安全
permalink: 02
---

<blockquote class="blockquote-center">我自横刀向天笑 去留肝胆两昆仑</blockquote>
　　原本想复现一下CVE-2017-7494漏洞再分享出来的，没曾想过程一波三折，还是在此记录一下失败的复现过程吧，为了纪念一下折腾不止的岁月，还有原谅我没有最终复现成功-！-。
<!--more -->
　　关于此漏洞的介绍不用多说，可以移步　<font color="#0593d3">[Samba远程代码执行漏洞|Freebuf](http://www.freebuf.com/vuls/135624.html)</font>　Samba远程代码执行漏洞被业内称为linux版的永恒之蓝，危害可想而知。当然相比windows来说，linux下的445端口是默认关闭的，而有些版本的linux并没有自带samba软件，算是万幸。

### 漏洞影响版本
Samba 3.5.0到4.6.4/4.5.10/4.4.14的中间版本。

### 漏洞利用条件
* 服务器打开了文件/打印机共享端口445
* 共享文件拥有访问以及写入权限
* 攻击者知道共享的目录路径

　　目前测试发现匿名登录与需要账号密码登录的情况都可以成功执行此漏洞，当然设置了账号密码的，在攻击时需要提供正确的账号密码。

### 漏洞利用原理
攻击者可通过上传恶意的链接库文件（.so），使服务端程序加载并执行它，从而实现远程代码执行。

### EXP
MSF已经更新了此漏洞的利用模块，链接：[is_known_pipename.rb](https://github.com/hdm/metasploit-framework/blob/0520d7cf76f8e5e654cb60f157772200c1b9e230/modules/exploits/linux/samba/is_known_pipename.rb)
另外国外大牛也用python写了个利用脚本（exp）：[42060.py](https://www.exploit-db.com/exploits/42060/)

### 复现的坑
　　想要复现此漏洞，首先得搭建一个靶机（不建议找公网的机子测试）。于是我找了台ubuntu服务器（14.04.1-Ubuntu），此版本默认安装了samba（Version 4.3.11-Ubuntu）省去了一些安装的麻烦，那么接下来就是要配置samba。
首先创建一个目录用于共享
```bash
mkdir /home/share
```
然后设置权限（若不设置权限，用户将会没有写权限）
```bash
chmod 777 /home/share
```
最后修改samba配置文件：
```bash
vim /etc/samba/smb.conf
```
在文件最后添加一下内容：
```bash
[myshare]
comment=smb share test
browseable=yes #可读
writeable=yes #可写
path=/home/share  #设置目录（上一步创建的共享目录）
public = yes #允许匿名登录
```
开启samba服务
```bash
/etc/init.d/smbd start  #开启
/etc/init.d/smbd stop   #关闭
/etc/init.d/smbd restart #重启
```
开启后，尝试远程访问一下：\\\\ip，经过测试我发现可以匿名登录，登录以后也有写权限。

靶机搭建完毕，接下来就开启MSF神器吧。

　　首先我在MAC上更新了msf，直接敲命令：*msfupdate*，没过多久更新成功了，于是我准备启动msf，输入命令：*msfconsole*，结果报错了（一脸懵逼）。
```bash
dyld: lazy symbol binding failed: Symbol not found: _clock_gettime
  Referenced from: /opt/metasploit-framework/embedded/lib/libruby.2.4.1.dylib (which was built for Mac OS X 10.12)
  Expected in: /usr/lib/libSystem.B.dylib

dyld: Symbol not found: _clock_gettime
  Referenced from: /opt/metasploit-framework/embedded/lib/libruby.2.4.1.dylib (which was built for Mac OS X 10.12)
  Expected in: /usr/lib/libSystem.B.dylib

/opt/metasploit-framework/bin/msfdb: line 23:  4721 Trace/BPT trap: 5       ruby "$INSTALL_DIR/embedded/framework/msfdb" "$@"
dyld: lazy symbol binding failed: Symbol not found: _clock_gettime
  Referenced from: /opt/metasploit-framework/embedded/lib/libruby.2.4.1.dylib (which was built for Mac OS X 10.12)
  Expected in: /usr/lib/libSystem.B.dylib

dyld: Symbol not found: _clock_gettime
  Referenced from: /opt/metasploit-framework/embedded/lib/libruby.2.4.1.dylib (which was built for Mac OS X 10.12)
  Expected in: /usr/lib/libSystem.B.dylib

/opt/metasploit-framework/bin/msfconsole: line 123:  4725 Trace/BPT trap: 5       $BIN/ruby $FRAMEWORK/$cmd $db_args "$@"
```
　　本人第一次碰见这个报错，于是只能上google查找解决方案，翻查一会在Github的[Issues](https://github.com/rapid7/metasploit-framework/issues/8302)中发现了这个错误，错误原因是mac10.11版本不支持最新版的msf，需要将mac升级到10.12然后升级xcode。
　　此时我的心情是崩溃的，首先我的是黑苹果，好不容易安装10.11成功了，想要突破到10.12谈何容易，其次msf已经被我升级了，怎么回退啊请问！舒缓心情后，继续折腾，那么既然mac上的msf不能用了，我就只能开一个虚拟机，好在之前虚拟机里面安装过kali，因此这回直接可以用了。打开kali后，我原本也想用msfupdate更新msf到最新版，但想想其实主要就是下载那个sabma漏洞的利用脚本。
　　为了俭省时间，我直接去github上下载了is_known_pipename.rb，然后扔进了*/usr/share/metasploit-framework/modules/exploits/linux/samba/*目录下。然而当我运行msfconsole，加载is_known_pipename模块后，发现没有payload模块可以选择，因此攻击不能成功。没办法，只能选择利用msfupdate重新更新。更新完以后，我成功加载了此模块以及payload，也设置好参数了，可悲剧的事情又发生了，exploit实施攻击后，向靶机写入文件成功了，但是没有回链session。
　　起初我以为是匿名登录的原因，于是设置了samba账号密码，并且在msf上也设置了SMBPass与SMBUser，然而session仍然没有成功创建。然后我怀疑是靶机无法直接连接虚拟机监听的端口，然而当用nc测试后发现可以连通。最后在逛tools时发现，此exp只适合64位的kali，虽然我不明白这跟kali的版本有毛关系，但事实是我的kali是32位的并且我没有复现成功。
　　*那么我会去开启64位的kali测试吗？我想我会的，抒写此文时，我正在安装64位的kali，为了复现个漏洞我容易吗！？*

### 修复方案
* 打补丁
* 升级到Samba 4.6.4/4.5.10/4.4.14任意版本
* 在smb.conf的[global]板块中添加参数：nt pipe support = no 然后重启smbd服务。

### 复现成功的案例
http://mp.weixin.qq.com/s/qWFe3yBg6NUU_kyVRiAzeA（复现了需要账号密码的情况）
http://www.freebuf.com/vuls/135624.html 



>转载请说明出处：[Samba远程代码执行漏洞(CVE-2017-7494)|nMask'Blog](http://thief.one/2017/05/25/2)
本文地址：http://thief.one/2017/05/25/2